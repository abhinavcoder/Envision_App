<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="lib/onsenui/css/onsenui.css" />
    <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css" />
    <link rel="stylesheet" href="css/index.css" />
    <script src="lib/onsenui/js/onsenui.min.js"></script>
    <script type="text/javascript" src="cordova.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <!--<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"></script>-->
    <script>
        var recognition=null;
        var picture;
        var params = {
            "visualFeatures": "Description",
            "language": "en",
        };
        var img_id;

        $('#main-button').css('height', $('#main-button').css("width"));
        document.addEventListener('deviceready', onDeviceReady, false);

        function speak(text) {
            TTS.speak(text, function () {
            }, function (reason) {
                alert(reason);
            });

        }

        function onDeviceReady() {
            recognition = new SpeechRecognition();
            recognition.onresult = function (event) {
                if (event.results.length > 0) {
                    //q.value = event.results[0][0].transcript;
                    //q.form.submit();
                    result = event.results[0][0].transcript.trim();
                    if (result.toLowerCase() == "camera" || result.toLowerCase() == "open camera") {

                        speak('Opening Camera!');
                        CameraPreview.startCamera({ camera: "back", tapPhoto: true, previewDrag: false, toBack: false });
                        return;
                    }

                    document.getElementById("main-status").innerHTML = event.results[0][0].transcript;
                    
                    console.log(img_id);
                    $.post("http://vqa.daylen.com/api/upload_question", {
                        'img_id': img_id,
                        'question': event.results[0][0].transcript
                    })
                    .done(function (data) {
                        $("#main-status").html(data['answer']);
                        speak(data['answer']);
                    })
                    .fail(function (a, b, c) {
                        alert("error");
                        alert(a);
                        alert(b);
                        alert(c);
                    });
                }
            }
            CameraPreview.setOnPictureTakenHandler(function (result) {
                CameraPreview.stopCamera();
                document.getElementById('loading-buzy').style.display = 'block';
                $.post('http://40.71.33.178/save',{data:result},
                    function (data) {
                        r = JSON.parse(data);
                        data = r['local'];
                        img_id = r['img_id']
                        console.log(JSON.stringify(r));
                        $('#loading-buzy').css('display', 'none');
                        $("#url").val("http://40.71.33.178/" + data);
                        $.ajax({
                            url: "https://api.projectoxford.ai/vision/v1.0/analyze?" + $.param(params),
                            beforeSend: function (xhrObj) {
                                // Request headers
                                xhrObj.setRequestHeader("Content-Type", "application/json");
                                xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key", "01e50a2eb00342d8bbdf1dc1744631a5");
                            },
                            type: "POST",
                            // Request body
                            data: "{'url':'" + "http://40.71.33.178/" + data + "'}",
                        })
                        .done(function (data) {
                            speak(data['description']['captions'][0]['text']);
                            $('#main-status').html(data['description']['captions'][0]['text']);
                        })
                        .fail(function () {
                            alert("error");
                        });
                });
            });
        }
    </script>
</head>

<body>
    <ons-page>
        <ons-toolbar>
            <div class="left">
                <img style="height:100%;" src="images/logo.png" />
            </div>
            <div class="center">
                Envision
            </div>
            <!--<div class="right">
              <ons-toolbar-button>
                <ons-icon icon="md-menu"></ons-icon>
              </ons-toolbar-button>
            </div>-->
        </ons-toolbar>
        <ons-button id="main-button" style="font-size:60px ">
            <i class="fa fa-camera" aria-hidden="true"></i>
            <span style="font-size:80px">|</span>
            <i class="fa fa-microphone" aria-hidden="true"></i>

        </ons-button>
        <div id="main-status" style="">
            Welcome to Envision. <br />
            Tap to speak. Click to Snap
        </div>
        <form action="http://visualqa.csail.mit.edu/cgi-bin/image_vqa.py" id="form" method="post" enctype="multipart/form-data" target="icontent">
            <input id="url" type="hidden" name="url" value="http://40.71.33.178/static/1484393884.jpg" />
            <input type="hidden" name="random" value="56476846" />
            <input id="question" type="hidden" name="question" value="what food?" />
            <input type="submit" value="Submit" onclick="makeRequest();" />
        </form>
        
        <ons-progress-circular id="loading-buzy" indeterminate style="display:none;"></ons-progress-circular>
        <iframe name="icontent" id="icontent"></iframe>
    </ons-page>

    <script>
        
        function makeRequest() {
            
        }
        $('#main-button').css('height', $('#main-button').css("width"));
        $("#form").bind('ajax:complete', function() {

                 alert("hola_senotira"); 


        });
        (function () {

            document.addEventListener("hold", function () {
                if (event.target.matches("#main-button")) {
                    recognition.start();
                }
            });
            document.addEventListener("release", function () {
                if (event.target.matches("#main-button")) {
                    recognition.stop();
                }
            });

            document.getElementById("main-button").addEventListener("click", function (event) {
                speak('Opening Camera!')
                CameraPreview.startCamera({ camera: "back", tapPhoto: true, previewDrag: false, toBack: false });

            });

        })();

    </script>
</body>

</html>
